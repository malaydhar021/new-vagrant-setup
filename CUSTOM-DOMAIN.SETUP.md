# Custom Domain Setup Instructions

Custom domain feature is something like people can create campaign script and review link from *** Sticky Reviews *** application
with their own domain name so that main application url does not appear to the end users

Following steps are required to perform before custom domain in action. With these setup custom domain feature is not going to work.

### Steps to follow

1. Get the directory path of vhosts inside project directory and update /etc/nginx/nginx.conf file adding `include <path/to/vhosts>/*;` under
http block. The include command should look like `include /var/www/html/stickyreviews/vhosts/*;`. After then restart the nginx server by running
`sudo service nginx restart`.

2. Now edit `/etc/nginx/sites-available/default` site and update root to project directory path. And also enable php for this default site in order to make it works.

The example config should look like below block.

```
##
# You should look at the following URL's in order to grasp a solid understanding
# of Nginx configuration files in order to fully unleash the power of Nginx.
# https://www.nginx.com/resources/wiki/start/
# https://www.nginx.com/resources/wiki/start/topics/tutorials/config_pitfalls/
# https://wiki.debian.org/Nginx/DirectoryStructure
#
# In most cases, administrators will remove this file from sites-enabled/ and
# leave it as reference inside of sites-available where it will continue to be
# updated by the nginx packaging team.
#
# This file will automatically load configuration files provided by other
# applications, such as Drupal or Wordpress. These applications will be made
# available underneath a path with that package name, such as /drupal8.
#
# Please see /usr/share/doc/nginx-doc/examples/ for more detailed examples.
##

# Default server configuration
#
server {
	listen 80 default_server;
	listen [::]:80 default_server;

	# SSL configuration
	#
	# listen 443 ssl default_server;
	# listen [::]:443 ssl default_server;
	#
	# Note: You should disable gzip for SSL traffic.
	# See: https://bugs.debian.org/773332
	#
	# Read up on ssl_ciphers to ensure a secure configuration.
	# See: https://bugs.debian.org/765782
	#
	# Self signed certs generated by the ssl-cert package
	# Don't use them in a production server!
	#
	# include snippets/snakeoil.conf;

	root /var/www/html/stickyreviews;
	# root /var/www/html;

	# Add index.php to the list if you are using PHP
	index index.html index.php index.htm index.nginx-debian.html;

	server_name _;

	location / {
		# First attempt to serve request as file, then
		# as directory, then fall back to displaying a 404.
		try_files $uri $uri/ =404;
	}

	# pass PHP scripts to FastCGI server
	#
	location ~ \.php$ {
		include snippets/fastcgi-php.conf;
	#
	#	# With php-fpm (or other unix sockets):
		fastcgi_pass unix:/var/run/php/php7.3-fpm.sock;
	#	# With php-cgi (or other tcp sockets):
	#	fastcgi_pass 127.0.0.1:9000;
	}
	
	# deny access to .htaccess files, if Apache's document root
	# concurs with nginx's one
	#
	#location ~ /\.ht {
	#	deny all;
	#}
}


# Virtual Host configuration for example.com
#
# You can move that to a different file under sites-available/ and symlink that
# to sites-enabled/ to enable it.
#
#server {
#	listen 80;
#	listen [::]:80;
#
#	server_name example.com;
#
#	root /var/www/example.com;
#	index index.html;
#
#	location / {
#		try_files $uri $uri/ =404;
#	}
#}
```
After finishing editing the nginx server needs to be restart by running command `sudo service nginx restart`.

3. Now as php has been run through `www-data` user so this user have to be a sudo user and the sudoer file needs to be update with following commands.
run `sudo visudo` and paste the below line at the end of this file.

`www-data ALL=NOPASSWD: ALL`

and then restart the server.

4. Go to project root directory for example `/var/www/html/stickyreviews` and run `composer update` to install/update required packages.

5. Create a migration for updating users table adding a column called `access_token` and update this column while a user is logged in to system.

Example code should look lik
```
User::find(Auth::user()->id)->update(["access_token" => $this->getToken()]);
```
and here is the getToken() method definition 
```
/**
* Method to generate random token. This token will be updated to user row once a user is logged in.
* This token is required when custom domain CNAME verification will be done.
* @since 1.0.0
* @return type String
*/
public function getToken() {
    return md5(rand()); 
}
```
6. Now open `index.php` under project root directory for example `/var/www/html/stickyreviews` and update the api dotenv path constant.

### Testing instruction

That's all. If everything works perfect then custom domain virtualhosts will be created under `vhosts` directory under project root.

To test in local you have to add domain to `/etc/hosts` in order to check cname verification. Example will look like below.
```
127.0.0.1       somecustomdomain.com
```

and for production or stage environment create one A record named `cname.{domainame}.{com}` in DNS configuration and put the IP address of your server host. Now to create a custom domain user have to create a cname record to there domain DNS configuration which will be pointed to `cname.{domainname}.{com}`


Happy coding! :metal:

